<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Cardíaco</title>
    <style>
        /* Mantido o mesmo estilo anterior */
    </style>
</head>
<body>
    <h1>Monitor de Frequência Cardíaca</h1>
    <div id="videoContainer">
        <video id="preview" playsinline autoplay></video>
    </div>
    <button id="startBtn" class="btn">Iniciar Medição</button>
    <button id="stopBtn" class="btn" disabled>Parar</button>
    <div id="result">-- bpm</div>
    <div id="error" style="color: red; margin: 15px;"></div>

    <script>
        const video = document.getElementById('preview');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const result = document.getElementById('result');
        const error = document.getElementById('error');

        let mediaStream;
        let intervalId;

        async function startMeasurement() {
            try {
                error.textContent = '';
                
                // 1. Solicitar acesso básico à câmera primeiro
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });

                video.srcObject = mediaStream;
                startBtn.disabled = true;
                stopBtn.disabled = false;

                // 2. Tentar ativar a lanterna após acesso concedido
                const track = mediaStream.getVideoTracks()[0];
                try {
                    await track.applyConstraints({
                        advanced: [{ torch: true }]
                    });
                } catch (torchError) {
                    error.innerHTML = 'Ative a lanterna manualmente!<br>Posicione o dedo sobre a câmera';
                }

                // 3. Iniciar análise
                intervalId = setInterval(analyzeHeartRate, 150);

            } catch (error) {
                handleError(error);
            }
        }

        function handleError(err) {
            console.error('Erro:', err);
            error.innerHTML = `
                Permissão negada!<br>
                1. Verifique se o site tem acesso à câmera<br>
                2. Recarregue a página<br>
                3. Se persistir, reinicie o navegador
            `;
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        function analyzeHeartRate() {
            // Mantido igual à versão anterior
        }

        function stopMeasurement() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => {
                    if (track.readyState === 'live' && track.applyConstraints) {
                        track.applyConstraints({ advanced: [{ torch: false }] })
                            .catch(() => {});
                    }
                    track.stop();
                });
            }
            clearInterval(intervalId);
            startBtn.disabled = false;
            stopBtn.disabled = true;
            result.textContent = '-- bpm';
            video.srcObject = null;
        }

        // Event Listeners
        startBtn.addEventListener('click', startMeasurement);
        stopBtn.addEventListener('click', stopMeasurement);

        // Verificação de compatibilidade
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            error.textContent = 'Seu navegador não suporta acesso à câmera!';
            startBtn.disabled = true;
        }
    </script>
</body>
</html>
